<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accesso Quiz Protetto</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
        }
        
        .instructions {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .instructions ul {
            margin: 10px 0 10px 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn-start {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .warning-box {
            background: #ffeaea;
            border: 2px solid #ff4444;
            border-radius: 10px;
            padding: 20px;
            margin: 25px 0;
            text-align: center;
        }
        
        .teacher-note {
            margin-top: 30px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container login-container">
        <div class="header">
            <h1>üõ°Ô∏è Accesso Quiz Protetto</h1>
            <p class="subtitle">Sistema ExamLock - Verifica Controllata</p>
        </div>
        
        <div class="instructions">
            <h3>‚ö†Ô∏è IMPORTANTE - Leggere prima di iniziare</h3>
            <p>Questo sistema attiva protezioni anti-copia:</p>
            <ul>
                <li>Schermo intero obbligatorio</li>
                <li>Blocco tasti di scelta rapida (F12, Ctrl+Shift+I, ecc.)</li>
                <li>Rilevamento uscita dalla pagina</li>
                <li>Timer di 30 minuti</li>
                <li>Registro attivit√† sospette</li>
            </ul>
            <p><strong>Non uscire dalla finestra durante il quiz!</strong></p>
        </div>
        
        <div class="card">
            <h2>üìù Identificazione Studente</h2>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="studentName">Nome:</label>
                    <input type="text" id="studentName" required 
                           placeholder="Es: Mario" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="studentSurname">Cognome:</label>
                    <input type="text" id="studentSurname" required 
                           placeholder="Es: Rossi" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="studentClass">Classe:</label>
                    <input type="text" id="studentClass" required 
                           placeholder="Es: 3A" autocomplete="off">
                </div>
                
                <!-- QUI SOSTITUISCI CON IL TUO LINK GOOGLE FORM -->
                <input type="hidden" id="quizUrl" 
                       value="https://docs.google.com/forms/d/e/1FAIpQLSevHhPLA7B9Np_u-4kpEEamHQTnigom5_gX2FNn95czc7vcMA/viewform?usp=dialog">
                <!-- CAMBIA "https://forms.gle/TUO_LINK_QUI" con il tuo link reale -->
                
                <div class="warning-box">
                    <h3>üö® AVVISO SICUREZZA</h3>
                    <p>Il sistema registrer√†:</p>
                    <ul style="text-align: left;">
                        <li>Le attivit√† sospette (cambio tab, uscite, ecc.)</li>
                        <li>L'orario di inizio e fine</li>
                        <li>Eventuali tentativi di bypass delle protezioni</li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <input type="checkbox" id="agreeTerms" required>
                    <label for="agreeTerms" style="display: inline; font-size: 14px;">
                        Confermo di aver letto le istruzioni e accetto le condizioni di utilizzo.
                        Sono consapevole che attivit√† sospette verranno registrate.
                    </label>
                </div>
                
                <button type="submit" class="btn-start">
                    üöÄ INIZIA QUIZ IN MODALIT√Ä PROTETTA
                </button>
            </form>
        </div>
        
        <div class="teacher-note">
            <p><strong>Nota per l'insegnante:</strong></p>
            <p>Per cambiare il Google Form del quiz, modifica il file <code>index.html</code></p>
            <p>Cerca: <code>value="https://forms.gle/TUO_LINK_QUI"</code> e sostituisci con il tuo link.</p>
            <p><a href="dashboard.html" style="color: #4285f4;">üîó Vai alla Dashboard di monitoraggio</a></p>
        </div>
    </div>
    
    <script>
        // Rileva se siamo su dispositivo mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Recupera dati studente
            const studentData = {
                name: document.getElementById('studentName').value.trim(),
                surname: document.getElementById('studentSurname').value.trim(),
                class: document.getElementById('studentClass').value.trim(),
                quizUrl: document.getElementById('quizUrl').value,
                device: isMobile ? 'mobile' : 'desktop',
                userAgent: navigator.userAgent,
                screenSize: `${window.innerWidth}x${window.innerHeight}`,
                sessionId: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                startTime: new Date().toISOString(),
                violations: []
            };
            
            // Validazione
            if (!studentData.name || !studentData.surname || !studentData.class) {
                alert('‚ö†Ô∏è Compila tutti i campi: Nome, Cognome e Classe');
                return;
            }
            
            if (!studentData.quizUrl.includes('forms.gle') && !studentData.quizUrl.includes('docs.google.com/forms')) {
                alert('‚ö†Ô∏è Contatta l\'insegnante: Link del quiz non configurato correttamente');
                return;
            }
            
            console.log('üìù Dati studente:', studentData);
            
            // Salva nei localStorage
            localStorage.setItem('examlock_student', JSON.stringify(studentData));
            localStorage.setItem('examlock_session_id', studentData.sessionId);
            
            // Salva anche in un archivio globale (per la dashboard)
            let allStudents = JSON.parse(localStorage.getItem('examlock_all_students') || '[]');
            allStudents.push({
                id: studentData.sessionId,
                name: studentData.name + ' ' + studentData.surname,
                class: studentData.class,
                startTime: studentData.startTime,
                status: 'active',
                violations: [],
                lastUpdate: new Date().toISOString()
            });
            localStorage.setItem('examlock_all_students', JSON.stringify(allStudents));
            
            // Log di inizio (facoltativo)
            try {
                fetch('https://api.mocky.io/api/v1/logs', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'quiz_started',
                        student: `${studentData.name} ${studentData.surname}`,
                        class: studentData.class,
                        time: studentData.startTime
                    })
                }).catch(() => {/* Ignora errori se non connesso */});
            } catch (e) {}
            
            // Reindirizza alla pagina di avvio protetto
            window.location.href = 'quiz-locked.html';
        });
        
        // Pulisci sessioni vecchie (> 24 ore) al caricamento
        window.addEventListener('load', function() {
            try {
                const allStudents = JSON.parse(localStorage.getItem('examlock_all_students') || '[]');
                const now = new Date();
                const updatedStudents = allStudents.filter(student => {
                    const studentTime = new Date(student.lastUpdate);
                    const hoursDiff = (now - studentTime) / (1000 * 60 * 60);
                    return hoursDiff < 24; // Mantieni solo ultime 24 ore
                });
                
                if (updatedStudents.length !== allStudents.length) {
                    localStorage.setItem('examlock_all_students', JSON.stringify(updatedStudents));
                    console.log('üîÑ Sessioni vecchie rimosse');
                }
            } catch (e) {}
        });
    </script>
</body>
</html>