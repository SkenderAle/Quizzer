<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Dashboard Insegnante - Sistema di Monitoraggio Quiz</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 22px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 5px solid #4285f4;
        }
        
        .stat-card.critical { border-left-color: #ff4444; }
        .stat-card.warning { border-left-color: #ff9800; }
        .stat-card.success { border-left-color: #4cd137; }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dashboard-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th {
            background: #f8f9fa;
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: #444;
            border-bottom: 2px solid #e9ecef;
            font-size: 14px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
            font-size: 14px;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        .violation-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-critical { background: #ffebee; color: #c62828; }
        .badge-violation { background: #fff3e0; color: #ef6c00; }
        .badge-warning { background: #e8f5e9; color: #2e7d32; }
        .badge-info { background: #e3f2fd; color: #1565c0; }
        
        .student-name {
            font-weight: 600;
            color: #1a237e;
        }
        
        .session-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .btn {
            padding: 10px 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .timestamp {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
        }
        
        .details-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .details-cell:hover {
            overflow: visible;
            white-space: normal;
            background: white;
            position: relative;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            min-width: 180px;
        }
        
        .search-box {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            flex-grow: 1;
            max-width: 300px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-section {
                padding: 15px;
                overflow-x: auto;
            }
            
            table {
                font-size: 13px;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Dashboard Insegnante - Sistema di Monitoraggio Quiz</h1>
            <p class="subtitle">Monitoraggio avanzato delle sessioni quiz - Tutti i dati sono salvati nel localStorage del browser</p>
        </header>
        
        <div class="stats-grid" id="statsGrid">
            <!-- Popolato da JavaScript -->
        </div>
        
        <div class="dashboard-section">
            <h2 class="section-title">üö® Ultime Violazioni & Eventi Critici</h2>
            <div class="filter-bar">
                <select id="filterSeverity" class="filter-select" onchange="loadViolations()">
                    <option value="all">Tutte le severit√†</option>
                    <option value="CRITICAL">Critiche</option>
                    <option value="VIOLATION">Violazioni</option>
                    <option value="WARNING">Warning</option>
                </select>
                <select id="filterTime" class="filter-select" onchange="loadViolations()">
                    <option value="all">Tutti i tempi</option>
                    <option value="today">Oggi</option>
                    <option value="week">Ultima settimana</option>
                </select>
                <input type="text" id="searchViolations" class="search-box" placeholder="Cerca studente o evento..." onkeyup="loadViolations()">
            </div>
            <div id="violationsTable">
                <!-- Popolato da JavaScript -->
            </div>
        </div>
        
        <div class="dashboard-section">
            <h2 class="section-title">üë• Sessioni Quiz Recenti</h2>
            <div id="sessionsTable">
                <!-- Popolato da JavaScript -->
            </div>
        </div>
        
        <div class="dashboard-section">
            <h2 class="section-title">üö® Emergenze Segnalate dagli Studenti</h2>
            <div id="emergenciesTable">
                <!-- Popolato da JavaScript -->
            </div>
        </div>
        
        <div class="dashboard-section">
            <h2 class="section-title">üìà Report Finali Quiz Completati</h2>
            <div id="reportsTable">
                <!-- Popolato da JavaScript -->
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn" onclick="exportAllData()">üì• Esporta Tutti i Dati (JSON)</button>
            <button class="btn btn-secondary" onclick="clearOldData()">üóëÔ∏è Pulisci Dati Vecchi (>30gg)</button>
            <button class="btn btn-danger" onclick="clearAllData()">‚ö†Ô∏è Cancella TUTTI i Dati</button>
            <button class="btn btn-success" onclick="location.reload()">üîÑ Ricarica Dati</button>
        </div>
        
        <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #666;">
            <p><strong>‚ÑπÔ∏è Informazioni tecniche:</strong> Tutti i dati sono salvati nel <code>localStorage</code> del browser. I dati persistono fino a quando non vengono manualmente cancellati. La dashboard legge da:</p>
            <ul style="margin-top: 8px; padding-left: 20px;">
                <li><code>quiz_all_sessions</code> - Sessioni attive/completate</li>
                <li><code>quiz_violations_summary</code> - Tutte le violazioni</li>
                <li><code>examlock_emergencies</code> - Segnalazioni emergenza</li>
                <li><code>examlock_final_reports</code> - Report finali quiz</li>
                <li><code>quiz_logs_*</code> - Log completi per studente</li>
            </ul>
        </div>
    </div>

    <script>
        // ==================== SISTEMA DASHBOARD ====================
        class TeacherDashboard {
            constructor() {
                this.data = {
                    sessions: [],
                    violations: [],
                    emergencies: [],
                    reports: [],
                    logs: {}
                };
                
                this.init();
            }
            
            init() {
                console.log('üìä Dashboard insegnante inizializzata');
                this.loadAllData();
                this.renderStats();
                this.loadViolations();
                this.loadSessions();
                this.loadEmergencies();
                this.loadReports();
            }
            
            loadAllData() {
                try {
                    // Sessioni globali
                    this.data.sessions = JSON.parse(localStorage.getItem('quiz_all_sessions') || '[]');
                    
                    // Violazioni
                    this.data.violations = JSON.parse(localStorage.getItem('quiz_violations_summary') || '[]');
                    
                    // Emergenze
                    this.data.emergencies = JSON.parse(localStorage.getItem('examlock_emergencies') || '[]');
                    
                    // Report finali
                    this.data.reports = JSON.parse(localStorage.getItem('examlock_final_reports') || '[]');
                    
                    // Log individuali (caricati on-demand)
                    this.loadStudentLogs();
                    
                } catch (e) {
                    console.error('‚ùå Errore caricamento dati:', e);
                    this.showError('Errore nel caricamento dei dati. Il localStorage potrebbe essere corrotto.');
                }
            }
            
            loadStudentLogs() {
                this.data.logs = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('quiz_logs_')) {
                        try {
                            const studentId = key.replace('quiz_logs_', '');
                            this.data.logs[studentId] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            console.warn(`Errore parsing log per chiave ${key}`);
                        }
                    }
                }
            }
            
            renderStats() {
                const statsGrid = document.getElementById('statsGrid');
                if (!statsGrid) return;
                
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                
                const stats = [
                    {
                        title: 'Sessioni Totali',
                        value: this.data.sessions.length,
                        color: 'success',
                        icon: 'üë•'
                    },
                    {
                        title: 'Violazioni Oggi',
                        value: this.data.violations.filter(v => v.timestamp && v.timestamp.startsWith(today)).length,
                        color: 'critical',
                        icon: 'üö®'
                    },
                    {
                        title: 'Quiz Completati',
                        value: this.data.reports.length,
                        color: 'success',
                        icon: '‚úÖ'
                    },
                    {
                        title: 'Emergenze Attive',
                        value: this.data.emergencies.filter(e => {
                            const time = new Date(e.timestamp);
                            return (now - time) < 24 * 60 * 60 * 1000; // Ultime 24h
                        }).length,
                        color: 'warning',
                        icon: 'üö®'
                    },
                    {
                        title: 'Studenti Monitorati',
                        value: Object.keys(this.data.logs).length,
                        color: 'success',
                        icon: 'üë®‚Äçüéì'
                    },
                    {
                        title: 'Violazioni Totali',
                        value: this.data.violations.length,
                        color: 'critical',
                        icon: '‚ö†Ô∏è'
                    }
                ];
                
                statsGrid.innerHTML = stats.map(stat => `
                    <div class="stat-card ${stat.color}">
                        <div class="stat-number">${stat.icon} ${stat.value}</div>
                        <div class="stat-label">${stat.title}</div>
                    </div>
                `).join('');
            }
            
            loadViolations() {
                const container = document.getElementById('violationsTable');
                if (!container) return;
                
                const severityFilter = document.getElementById('filterSeverity')?.value || 'all';
                const timeFilter = document.getElementById('filterTime')?.value || 'all';
                const searchTerm = document.getElementById('searchViolations')?.value.toLowerCase() || '';
                
                let filtered = this.data.violations;
                
                // Filtri
                if (severityFilter !== 'all') {
                    filtered = filtered.filter(v => {
                        if (severityFilter === 'CRITICAL') return v.type && v.type.includes('CRITICAL');
                        if (severityFilter === 'VIOLATION') return !v.type.includes('CRITICAL') && (v.severity === 'VIOLATION' || v.type.includes('VIOLATION') || v.type.includes('BLOCK'));
                        if (severityFilter === 'WARNING') return v.severity === 'WARNING' || v.type.includes('WARNING');
                        return true;
                    });
                }
                
                if (timeFilter !== 'all') {
                    const now = new Date();
                    filtered = filtered.filter(v => {
                        if (!v.timestamp) return false;
                        const eventTime = new Date(v.timestamp);
                        const diff = now - eventTime;
                        
                        if (timeFilter === 'today') return diff < 24 * 60 * 60 * 1000;
                        if (timeFilter === 'week') return diff < 7 * 24 * 60 * 60 * 1000;
                        return true;
                    });
                }
                
                if (searchTerm) {
                    filtered = filtered.filter(v => 
                        (v.studentName && v.studentName.toLowerCase().includes(searchTerm)) ||
                        (v.type && v.type.toLowerCase().includes(searchTerm)) ||
                        (v.details && v.details.toLowerCase().includes(searchTerm)) ||
                        (v.sessionId && v.sessionId.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Ordina per data (pi√π recente prima)
                filtered.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
                
                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div>üì≠</div>
                            <p>Nessuna violazione trovata con i filtri attuali</p>
                        </div>
                    `;
                    return;
                }
                
                // Mostra solo le ultime 50
                const displayItems = filtered.slice(0, 50);
                
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Studente</th>
                                <th>Tipo</th>
                                <th>Dettagli</th>
                                <th>Sessione</th>
                                <th>Orario</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${displayItems.map(violation => {
                                const time = violation.timestamp ? new Date(violation.timestamp).toLocaleString('it-IT') : 'N/A';
                                const severity = violation.type && violation.type.includes('CRITICAL') ? 'critical' : 
                                               violation.severity === 'VIOLATION' || violation.type.includes('VIOLATION') || violation.type.includes('BLOCK') ? 'violation' :
                                               violation.severity === 'WARNING' ? 'warning' : 'info';
                                
                                return `
                                    <tr>
                                        <td><span class="student-name">${violation.studentName || 'N/A'}</span></td>
                                        <td><span class="violation-badge badge-${severity}">${violation.type || violation.severity || 'EVENT'}</span></td>
                                        <td class="details-cell" title="${violation.details || ''}">${violation.details || ''}</td>
                                        <td><span class="session-id" title="${violation.sessionId || ''}">${(violation.sessionId || '').substring(0, 10)}...</span></td>
                                        <td class="timestamp">${time}</td>
                                        <td>
                                            <button onclick="viewStudentLogs('${violation.studentId || ''}')" style="padding: 4px 8px; font-size: 12px; background: #e3f2fd; border: none; border-radius: 4px; cursor: pointer;">
                                                üìã Log
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    ${filtered.length > 50 ? `<p style="margin-top: 10px; color: #666; font-size: 13px;">Mostrate 50/${filtered.length} violazioni. Usa i filtri per restringere.</p>` : ''}
                `;
            }
            
            loadSessions() {
                const container = document.getElementById('sessionsTable');
                if (!container) return;
                
                const sessions = this.data.sessions.sort((a, b) => 
                    new Date(b.startTime || 0) - new Date(a.startTime || 0)
                ).slice(0, 30); // Ultime 30 sessioni
                
                if (sessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div>üë•</div>
                            <p>Nessuna sessione quiz trovata</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Studente</th>
                                <th>ID Sessione</th>
                                <th>Inizio</th>
                                <th>Durata</th>
                                <th>Violazioni</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sessions.map(session => {
                                const startTime = session.startTime ? new Date(session.startTime).toLocaleString('it-IT') : 'N/A';
                                const duration = session.startTime ? 
                                    Math.round((new Date() - new Date(session.startTime)) / 60000) + ' min fa' : 'N/A';
                                
                                // Cerca log completi per questa sessione
                                const hasFullLog = Object.values(this.data.logs).some(log => 
                                    log && log.sessionId === session.sessionId
                                );
                                
                                return `
                                    <tr>
                                        <td><span class="student-name">${session.studentName || 'N/A'}</span></td>
                                        <td><span class="session-id" title="${session.sessionId || ''}">${(session.sessionId || '').substring(0, 12)}...</span></td>
                                        <td class="timestamp">${startTime}</td>
                                        <td>${duration}</td>
                                        <td><span class="violation-badge ${session.violationCount > 0 ? 'badge-violation' : 'badge-success'}">${session.violationCount || 0}</span></td>
                                        <td>
                                            <span class="violation-badge badge-info">
                                                ${hasFullLog ? 'LOG COMPLETO' : 'SINTESI'}
                                            </span>
                                        </td>
                                        <td>
                                            <button onclick="viewSessionDetails('${session.sessionId}')" style="padding: 4px 8px; font-size: 12px; background: #e3f2fd; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                                üîç Dettagli
                                            </button>
                                            ${hasFullLog ? `
                                                <button onclick="exportSessionLog('${session.sessionId}')" style="padding: 4px 8px; font-size: 12px; background: #e8f5e9; border: none; border-radius: 4px; cursor: pointer;">
                                                    üì• Log
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            loadEmergencies() {
                const container = document.getElementById('emergenciesTable');
                if (!container) return;
                
                const emergencies = this.data.emergencies.sort((a, b) => 
                    new Date(b.timestamp || 0) - new Date(a.timestamp || 0)
                ).slice(0, 20);
                
                if (emergencies.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div>üö®</div>
                            <p>Nessuna emergenza segnalata</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Studente</th>
                                <th>Problema</th>
                                <th>Orario</th>
                                <th>Sessione</th>
                                <th>Violazioni</th>
                                <th>Tempo Rimanente</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${emergencies.map(emergency => {
                                const time = emergency.timestamp ? new Date(emergency.timestamp).toLocaleString('it-IT') : 'N/A';
                                const studentName = emergency.student ? 
                                    `${emergency.student.name || ''} ${emergency.student.surname || ''}`.trim() : 'N/A';
                                const problem = emergency.problem || 'Nessun dettaglio';
                                
                                return `
                                    <tr>
                                        <td><span class="student-name">${studentName}</span></td>
                                        <td class="details-cell" title="${problem}">${problem.length > 80 ? problem.substring(0, 80) + '...' : problem}</td>
                                        <td class="timestamp">${time}</td>
                                        <td><span class="session-id">${(emergency.sessionId || '').substring(0, 10)}...</span></td>
                                        <td>${emergency.violations || 0}</td>
                                        <td>${emergency.timeLeft ? Math.floor(emergency.timeLeft / 60) + ' min' : 'N/A'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            loadReports() {
                const container = document.getElementById('reportsTable');
                if (!container) return;
                
                const reports = this.data.reports.sort((a, b) => 
                    new Date(b.endTime || b.startTime || 0) - new Date(a.endTime || a.startTime || 0)
                ).slice(0, 20);
                
                if (reports.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div>üìà</div>
                            <p>Nessun report finale disponibile</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Studente</th>
                                <th>Risultato</th>
                                <th>Violazioni</th>
                                <th>Durata</th>
                                <th>Eventi</th>
                                <th>Fine</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reports.map(report => {
                                const endTime = report.endTime ? new Date(report.endTime).toLocaleString('it-IT') : 'N/A';
                                const duration = report.timeSpent ? Math.floor(report.timeSpent / 60) + ' min' : 'N/A';
                                const studentName = report.studentName || (report.student ? 
                                    `${report.student.name || ''} ${report.student.surname || ''}`.trim() : 'N/A');
                                
                                return `
                                    <tr>
                                        <td><span class="student-name">${studentName}</span></td>
                                        <td><span class="violation-badge ${report.endReason === 'TEMPO SCADUTO' ? 'badge-warning' : report.violationCount > 2 ? 'badge-critical' : 'badge-success'}">
                                            ${report.endReason || 'COMPLETATO'}
                                        </span></td>
                                        <td><span class="violation-badge ${report.violationCount > 0 ? 'badge-violation' : 'badge-success'}">${report.violationCount || 0}</span></td>
                                        <td>${duration}</td>
                                        <td>${report.totalEvents || 0}</td>
                                        <td class="timestamp">${endTime}</td>
                                        <td>
                                            <button onclick="viewFullReport('${report.sessionId}')" style="padding: 4px 8px; font-size: 12px; background: #e3f2fd; border: none; border-radius: 4px; cursor: pointer;">
                                                üìÑ Report
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            showError(message) {
                alert(`‚ùå Errore Dashboard: ${message}`);
            }
        }
        
        // ==================== FUNZIONI GLOBALI ====================
        let dashboard = null;
        
        function initDashboard() {
            dashboard = new TeacherDashboard();
        }
        
        function viewStudentLogs(studentId) {
            if (!studentId) {
                alert('ID studente non disponibile');
                return;
            }
            
            const logKey = `quiz_logs_${studentId}`;
            const logData = localStorage.getItem(logKey);
            
            if (!logData) {
                alert('Nessun log trovato per questo studente');
                return;
            }
            
            try {
                const parsed = JSON.parse(logData);
                const win = window.open('', '_blank');
                win.document.write(`
                    <html>
                    <head><title>Log Completo - ${studentId}</title>
                    <style>body {font-family: monospace; padding: 20px; background: #f5f5f5;}</style>
                    </head>
                    <body>
                        <h2>üìã Log Completo Studente: ${studentId}</h2>
                        <pre>${JSON.stringify(parsed, null, 2)}</pre>
                        <button onclick="window.print()" style="padding: 10px; margin: 20px 0;">üñ®Ô∏è Stampa Log</button>
                        <button onclick="window.close()" style="padding: 10px; margin-left: 10px;">‚ùå Chiudi</button>
                    </body>
                    </html>
                `);
            } catch (e) {
                alert('Errore visualizzazione log');
            }
        }
        
        function viewSessionDetails(sessionId) {
            if (!sessionId) return;
            
            // Cerca sessioni
            const allSessions = JSON.parse(localStorage.getItem('quiz_all_sessions') || '[]');
            const session = allSessions.find(s => s.sessionId === sessionId);
            
            // Cerca violazioni
            const allViolations = JSON.parse(localStorage.getItem('quiz_violations_summary') || '[]');
            const sessionViolations = allViolations.filter(v => v.sessionId === sessionId);
            
            // Cerca log completo
            let fullLog = null;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('quiz_logs_')) {
                    try {
                        const log = JSON.parse(localStorage.getItem(key));
                        if (log.sessionId === sessionId) {
                            fullLog = log;
                            break;
                        }
                    } catch (e) {}
                }
            }
            
            const win = window.open('', '_blank');
            const content = `
                <html>
                <head><title>Dettagli Sessione - ${sessionId.substring(0, 15)}...</title>
                <style>
                    body {font-family: 'Segoe UI', sans-serif; padding: 25px; background: #f8f9fa;}
                    .card {background: white; padding: 20px; margin: 15px 0; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08);}
                    h2 {color: #1a237e;}
                    .violation {background: #ffebee; padding: 10px; margin: 8px 0; border-left: 4px solid #f44336;}
                    .event {background: #f5f5f5; padding: 8px; margin: 5px 0; font-family: monospace; font-size: 13px;}
                </style>
                </head>
                <body>
                    <h2>üîç Dettagli Sessione</h2>
                    
                    <div class="card">
                        <h3>Informazioni Sessione</h3>
                        <p><strong>ID:</strong> ${sessionId}</p>
                        ${session ? `
                            <p><strong>Studente:</strong> ${session.studentName || 'N/A'}</p>
                            <p><strong>Inizio:</strong> ${session.startTime ? new Date(session.startTime).toLocaleString('it-IT') : 'N/A'}</p>
                            <p><strong>Violazioni:</strong> ${session.violationCount || 0}</p>
                        ` : '<p>Informazioni sessione non trovate</p>'}
                    </div>
                    
                    ${sessionViolations.length > 0 ? `
                        <div class="card">
                            <h3>üö® Violazioni (${sessionViolations.length})</h3>
                            ${sessionViolations.map(v => `
                                <div class="violation">
                                    <strong>${v.type || 'VIOLAZIONE'}</strong><br>
                                    <small>${v.timestamp ? new Date(v.timestamp).toLocaleString('it-IT') : ''}</small><br>
                                    ${v.details || ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${fullLog && fullLog.events ? `
                        <div class="card">
                            <h3>üìã Eventi Registrati (${fullLog.events.length})</h3>
                            <p><em>Ultimi 20 eventi:</em></p>
                            ${fullLog.events.slice(-20).map(e => `
                                <div class="event">
                                    [${e.localTime}] ${e.type}: ${e.details}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="card">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üñ®Ô∏è Stampa Report
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                            ‚ùå Chiudi
                        </button>
                    </div>
                </body>
                </html>
            `;
            
            win.document.write(content);
        }
        
        function exportSessionLog(sessionId) {
            // Trova il log
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('quiz_logs_')) {
                    try {
                        const log = JSON.parse(localStorage.getItem(key));
                        if (log.sessionId === sessionId) {
                            exportAsJSON(log, `quiz_log_${sessionId}_${new Date().toISOString().split('T')[0]}.json`);
                            return;
                        }
                    } catch (e) {}
                }
            }
            alert('Log non trovato');
        }
        
        function viewFullReport(sessionId) {
            const reports = JSON.parse(localStorage.getItem('examlock_final_reports') || '[]');
            const report = reports.find(r => r.sessionId === sessionId);
            
            if (!report) {
                alert('Report non trovato');
                return;
            }
            
            const win = window.open('', '_blank');
            win.document.write(`
                <html>
                <head><title>Report Finale - ${report.studentName || 'Quiz'}</title>
                <style>
                    body {font-family: 'Segoe UI', sans-serif; padding: 30px; background: #f8f9fa;}
                    .report {background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 900px; margin: auto;}
                    h1 {color: #1a237e; border-bottom: 3px solid #4285f4; padding-bottom: 10px;}
                    .stat {display: inline-block; background: #f5f5f5; padding: 15px; margin: 10px; border-radius: 8px; min-width: 150px;}
                    .violation-list {background: #fff3e0; padding: 15px; margin: 15px 0; border-radius: 8px;}
                    .violation-item {background: white; padding: 10px; margin: 8px 0; border-left: 4px solid #ff9800;}
                </style>
                </head>
                <body>
                    <div class="report">
                        <h1>üìä Report Finale Quiz</h1>
                        
                        <h2>Studente: ${report.studentName || 'N/A'}</h2>
                        <p><strong>ID Sessione:</strong> ${report.sessionId || 'N/A'}</p>
                        <p><strong>Data/ora fine:</strong> ${report.endTime ? new Date(report.endTime).toLocaleString('it-IT') : 'N/A'}</p>
                        
                        <div style="margin: 25px 0;">
                            <div class="stat">
                                <h3>‚è±Ô∏è Durata</h3>
                                <p style="font-size: 24px; font-weight: bold;">${report.timeSpent ? Math.floor(report.timeSpent / 60) + ' min' : 'N/A'}</p>
                            </div>
                            <div class="stat">
                                <h3>üö® Violazioni</h3>
                                <p style="font-size: 24px; font-weight: bold; color: ${report.violationCount > 0 ? '#f44336' : '#4caf50'}">${report.violationCount || 0}</p>
                            </div>
                            <div class="stat">
                                <h3>üìä Eventi</h3>
                                <p style="font-size: 24px; font-weight: bold;">${report.totalEvents || 0}</p>
                            </div>
                        </div>
                        
                        <h3>Esito: <span style="color: ${report.endReason === 'TEMPO SCADUTO' ? '#ff9800' : report.violationCount > 2 ? '#f44336' : '#4caf50'}">
                            ${report.endReason || 'COMPLETATO'}
                        </span></h3>
                        
                        ${report.violations && report.violations.length > 0 ? `
                            <div class="violation-list">
                                <h3>üìù Dettaglio Violazioni (${report.violations.length})</h3>
                                ${report.violations.map((v, i) => `
                                    <div class="violation-item">
                                        <strong>#${i+1} - ${v.type || 'Violazione'}</strong><br>
                                        <small>${v.time || ''}</small><br>
                                        ${v.details || ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                            <button onclick="window.print()" style="padding: 12px 25px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                üñ®Ô∏è Stampa Report
                            </button>
                            <button onclick="window.close()" style="padding: 12px 25px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-left: 15px;">
                                ‚ùå Chiudi
                            </button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }
        
        function exportAllData() {
            const allData = {
                exportDate: new Date().toISOString(),
                sessions: JSON.parse(localStorage.getItem('quiz_all_sessions') || '[]'),
                violations: JSON.parse(localStorage.getItem('quiz_violations_summary') || '[]'),
                emergencies: JSON.parse(localStorage.getItem('examlock_emergencies') || '[]'),
                reports: JSON.parse(localStorage.getItem('examlock_final_reports') || '[]'),
                studentLogs: {}
            };
            
            // Raccogli tutti i log studenti
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('quiz_logs_')) {
                    try {
                        allData.studentLogs[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {}
                }
            }
            
            exportAsJSON(allData, `quizzer_full_export_${new Date().toISOString().split('T')[0]}.json`);
        }
        
        function exportAsJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert(`‚úÖ Esportazione completata: ${filename}`);
        }
        
        function clearOldData() {
            if (!confirm('Vuoi eliminare tutti i dati pi√π vecchi di 30 giorni?')) return;
            
            const now = new Date();
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
            let cleared = 0;
            
            // Funzione helper per pulire array nel localStorage
            const cleanArray = (key) => {
                try {
                    const items = JSON.parse(localStorage.getItem(key) || '[]');
                    const filtered = items.filter(item => {
                        const date = item.timestamp || item.startTime || item.endTime;
                        if (!date) return true; // Mantieni se non ha data
                        return new Date(date) > thirtyDaysAgo;
                    });
                    
                    if (filtered.length < items.length) {
                        localStorage.setItem(key, JSON.stringify(filtered));
                        cleared += (items.length - filtered.length);
                    }
                } catch (e) {}
            };
            
            // Pulisci le collezioni principali
            cleanArray('quiz_all_sessions');
            cleanArray('quiz_violations_summary');
            cleanArray('examlock_emergencies');
            cleanArray('examlock_final_reports');
            
            // Pulisci log studenti vecchi
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('quiz_logs_')) {
                    try {
                        const log = JSON.parse(localStorage.getItem(key));
                        if (log.lastUpdate && new Date(log.lastUpdate) < thirtyDaysAgo) {
                            localStorage.removeItem(key);
                            cleared++;
                        }
                    } catch (e) {}
                }
            }
            
            alert(`‚úÖ Puliti ${cleared} elementi pi√π vecchi di 30 giorni.`);
            location.reload();
        }
        
        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE: Stai per cancellare TUTTI i dati del sistema!\n\nQuesta operazione non pu√≤ essere annullata.\n\nProcedere?')) return;
            
            // Lista di chiavi da preservare (eventuali impostazioni)
            const preserve = ['examlock_student', 'examlock_settings'];
            
            // Cancella tutte le chiavi relative al quiz
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!preserve.includes(key) && (
                    key.startsWith('quiz_') || 
                    key.startsWith('examlock_') && !key.includes('student') && !key.includes('settings')
                )) {
                    localStorage.removeItem(key);
                }
            }
            
            alert('‚úÖ TUTTI i dati del sistema sono stati cancellati.');
            location.reload();
        }
        
        // Inizializza quando la pagina √® caricata
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>